#!/usr/bin/env bash

_urlsave() {
	if [[ -e $mydir/data/urls.${config[server]}.db ]]; then source "$mydir/data/urls.${config[server]}.db"
	else declare -A urls=()
	fi

	local ticks chan=${line[2]} i title change text
	text="${line[*]:3}"
	read -ra text <<<"${text/:/}"
	#local text="${line[*]:3}"; text=( ${text/:/} )

	read -r ticks < <(date -u +%s)
	local change=0
	for i in "${text[@]}"; do
		[[ ${i,,} =~ ^[a-z]{3,}:// ]] || continue

		if ((${#urls[$i]})); then
			(( $(( $(date +%s) - ${urls[$i]} )) < ${urlsave[timeout]:-300} )) && continue
		fi

		read -r title < <(get_url_title "$i")
		((${#title})) || title='ENOTITLE'
		urls[$i]=$ticks
		privmsg "$chan" "^ ${title}" >&3
		change=1
	done
	((change)) && declare -p urls > "$mydir/data/urls.${config[server]}.db"
}
_urlsave
